input {
    udp {
        port => 9005
        tags => ["meraki"]
    }
}

filter {
    # Parse out syslog priority.
    grok {
        match => { "message" => "%{SYSLOG5424PRI}%{NUMBER}%{SPACE}%{NOTSPACE}%{SPACE}%{NOTSPACE:source}%{SPACE}%{NOTSPACE:meraki_event}%{SPACE}%{GREEDYDATA:message}" }
        overwrite => [ "message" ]
    }
    # Parse message as key-value and place in kv key.
    kv {
        field_split => " "
        target => "kv"
    }
    # Add "syslog_pri" to kv key.
    mutate {
        copy => { "[log][syslog][priority]" => "[kv][syslog_pri]" }
    }
    # Add "meraki_event" to kv key.
    mutate {
        copy => { "[meraki_event]" => "[kv][event]" }
    }
    # Add "job" key for loki label.
    mutate {
        add_field => { "job" => "syslog" }
    }
    # Add "syslog_pri" to kv key.
    mutate {
        copy => { "[log][syslog][priority]" => "[kv][syslog_pri]" }
    }
    mutate {
        gsub => [
            "source", "_", "-"
        ]
    }
    # Encode kv as json and place in "json" key.
    json_encode {
        source => "kv"
        target => "json"
    }
}

output {
    stdout {}
    loki {
        url => "http://loki:3100/loki/api/v1/push"
        include_fields => [ "job", "source" ]
        message_field => "json"
    }
}